name: API Test Automation with Enhanced Reporting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC for full regression
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests against'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

# Permissions set at job level for security (principle of least privilege)

# Global environment variables
env:
  TIMESTAMP: ${{ github.run_id }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: CODE QUALITY (runs in parallel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  code-quality:
    name: ğŸ¨ Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: ğŸ“¦ Install Ruff
        run: pip install ruff
      
      - name: ğŸ” Run Ruff Linter
        run: |
          echo "## ğŸ¨ Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ruff check . --output-format=github || true
          ruff check . --statistics >> $GITHUB_STEP_SUMMARY 2>&1 || true
      
      - name: ğŸ¯ Run Ruff Formatter Check
        run: |
          ruff format --check . || echo "âš ï¸ Some files need formatting" >> $GITHUB_STEP_SUMMARY

  type-check:
    name: ğŸ“Š Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install mypy types-requests
          pip install -r requirements.txt
      
      - name: ğŸ” Run MyPy Type Check
        run: |
          echo "## ğŸ“Š Type Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          mypy . --ignore-missing-imports --no-error-summary 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || true
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  build:
    name: ğŸ”¨ Build & Setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps chromium
      
      - name: ğŸ’¾ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pip-playwright-${{ hashFiles('requirements.txt') }}-${{ matrix.python-version }}
          restore-keys: |
            ${{ runner.os }}-pip-playwright-
      
      - name: ğŸ“ Create .env file
        run: |
          cat > .env << EOF
          ENV=${{ github.event.inputs.environment || 'dev' }}
          BASE_URL=https://eks-dev-lb.shadhinlab.xyz
          RETRY_COUNT=2
          PARALLEL_WORKERS=4
          REPORT_PORTAL_ENABLED=false
          EOF
      
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.python-version }}
          path: |
            .env
            requirements.txt
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: SMOKE TESTS (Fast feedback)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  smoke-tests:
    name: ğŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-3.12
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps chromium
      
      - name: ğŸ’¨ Run Smoke Tests
        id: smoke
        run: |
          # Run smoke tests and capture output
          pytest tests/ -v -m "smoke" --tb=short --maxfail=3 --junitxml=smoke-results.xml 2>&1 | tee smoke-output.txt
        continue-on-error: true
      
      - name: ğŸ“‹ Generate Smoke Test Summary
        if: always()
        run: |
          echo "## ğŸ’¨ Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract test counts
          PASSED=$(grep -oP '\d+(?= passed)' smoke-output.txt | head -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' smoke-output.txt | head -1 || echo "0")
          TOTAL=$((PASSED + FAILED))
          
          # Status badge
          if [ "$FAILED" = "0" ] && [ "$PASSED" != "0" ]; then
            echo "### âœ… All Smoke Tests Passed!" >> $GITHUB_STEP_SUMMARY
          elif [ "$FAILED" != "0" ]; then
            echo "### âŒ Some Smoke Tests Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ No Smoke Tests Found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          
          # Extract duration
          DURATION=$(grep -oP '\d+\.\d+s' smoke-output.txt | tail -1 || echo "N/A")
          echo "| â±ï¸ Duration | $DURATION |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>ğŸ“œ View Test Details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -E "PASSED|FAILED|ERROR" smoke-output.txt | head -20 >> $GITHUB_STEP_SUMMARY || echo "No test results found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: FULL TEST SUITE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: [build, smoke-tests]
    permissions:
      checks: write
      pull-requests: write
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.python-version }}
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps chromium
      
      - name: ğŸ§ª Run tests with pytest
        id: pytest
        run: |
          pytest tests/ -v \
            --tb=short \
            --maxfail=5 \
            --reruns 2 \
            --reruns-delay 1 \
            -n auto \
            --alluredir=./allure-results \
            --clean-alluredir \
            --junitxml=./test-results/junit.xml \
            --cov=. \
            --cov-report=xml:coverage.xml \
            --cov-report=html:coverage-report
        continue-on-error: true
      
      - name: ğŸ“Š Generate Allure Report
        if: always()
        run: |
          # Install Allure CLI (enforce HTTPS-only with TLS 1.2+)
          curl --proto "=https" --tlsv1.2 -sSf -L -o allure-2.25.0.tgz https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          tar -zxvf allure-2.25.0.tgz
          sudo mv allure-2.25.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          
          # Generate report
          allure generate ./allure-results -o ./allure-report --clean
      
      - name: ğŸ“… Generate Artifact Metadata
        if: always()
        run: |
          CREATED_AT=$(TZ='Asia/Dhaka' date '+%d/%m/%Y %H:%M:%S')
          echo "Created: $CREATED_AT" > ./allure-results/artifact-info.txt
          echo "Created: $CREATED_AT" > ./allure-report/artifact-info.txt
          echo "Created: $CREATED_AT" > ./test-results/artifact-info.txt 2>/dev/null || mkdir -p ./test-results && echo "Created: $CREATED_AT" > ./test-results/artifact-info.txt
          echo "ARTIFACT_TIMESTAMP=$CREATED_AT" >> $GITHUB_ENV
          echo "ğŸ“… Artifact Created: $CREATED_AT" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¤ Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.python-version }}-${{ github.run_number }}
          path: ./allure-results
          retention-days: 30
      
      - name: ğŸ“¤ Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.python-version }}-${{ github.run_number }}
          path: ./allure-report
          retention-days: 30
      
      - name: ğŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}-${{ github.run_number }}
          path: ./test-results
          retention-days: 30
      
      - name: ğŸ“¤ Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}-${{ github.run_number }}
          path: |
            coverage.xml
            coverage-report/
          retention-days: 30
      
      - name: ğŸ“ˆ Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@170bf24d20d201b842d7a52403b46b80f3a14d13  # v2.19.0
        with:
          files: ./test-results/junit.xml
          check_name: Test Results (Python ${{ matrix.python-version }})
      
      - name: âŒ Fail job if tests failed
        if: steps.pytest.outcome == 'failure'
        run: exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: SONARCLOUD CODE ANALYSIS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  sonarcloud:
    name: ğŸ”¬ SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: ğŸ“¥ Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-3.12-${{ github.run_number }}
          path: .
        continue-on-error: true
      
      - name: ğŸ”¬ SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@2500896589ef8f7247069a56136f8dc177c27ccf  # v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectPropertiesPath=sonarqube/sonar-project.properties
            -Dsonar.python.coverage.reportPaths=coverage.xml
      
      - name: ğŸ“‹ SonarCloud Summary
        run: |
          echo "## ğŸ”¬ SonarCloud Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **View Results:** [SonarCloud Dashboard](https://sonarcloud.io/project/overview?id=foyezkabir_playwright-api-automation-python)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Metrics Analyzed:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ› Bugs & Vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ Security Hotspots" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ’¨ Code Smells" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ˆ Duplications" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 6: COVERAGE REPORT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  coverage:
    name: ğŸ“ˆ Coverage Report
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
      - name: ğŸ“¥ Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-3.12-${{ github.run_number }}
          path: ./coverage
      
      - name: ğŸ“Š Generate Coverage Summary
        run: |
          echo "## ğŸ“ˆ Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage.xml ]; then
            echo "Coverage report generated successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 7: DEPLOY REPORTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy Reports
    runs-on: ubuntu-latest
    needs: [test, coverage, sonarcloud]
    if: always() && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“ Create publish directory
        run: mkdir -p publish
      
      - name: ğŸ“¥ Download Allure Report (Python 3.12)
        uses: actions/download-artifact@v4
        with:
          name: allure-report-3.12-${{ github.run_number }}
          path: ./publish/allure-report
      
      - name: ğŸ  Create root redirect page
        run: |
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report/index.html"
          cat > publish/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting to Allure Report...</title>
            <meta http-equiv="refresh" content="0; url=${REPORT_URL}">
            <script>
              window.location.href = "${REPORT_URL}";
            </script>
          </head>
          <body>
            <p>Redirecting to <a href="${REPORT_URL}">Allure Report</a>...</p>
          </body>
          </html>
          EOF
      
      - name: ğŸŒ Publish Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e  # v3.9.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./publish
          publish_branch: gh-pages
          force_orphan: true
      
      - name: ğŸ“‹ Report URL in Summary
        run: |
          echo "## ğŸ“Š Reports Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Report | Link |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ˆ **Allure Report** | [View Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¬ **SonarCloud** | [View Analysis](https://sonarcloud.io/project/overview?id=foyezkabir_playwright-api-automation-python) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports will be available in ~2 minutes after deployment completes." >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 7: NOTIFICATIONS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [code-quality, type-check, build, smoke-tests, test, sonarcloud, coverage, deploy, security-scan]
    if: always()
    
    steps:
      - name: ğŸ“Š Prepare Notification Summary
        id: summary
        run: |
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "status=âœ… Success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          elif [ "${{ needs.test.result }}" == "failure" ]; then
            echo "status=âŒ Failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸ ${{ needs.test.result }}" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“‹ Create GitHub Summary
        run: |
          echo "## ğŸ“¢ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¨ Code Quality | ${{ needs.code-quality.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Type Check | ${{ needs.type-check.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¨ Build | ${{ needs.build.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ’¨ Smoke Tests | ${{ needs.smoke-tests.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Tests | ${{ needs.test.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¬ SonarCloud | ${{ needs.sonarcloud.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ˆ Coverage | ${{ needs.coverage.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Deploy | ${{ needs.deploy.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Security | ${{ needs.security-scan.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status:** ${{ steps.summary.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Reports" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— **Allure Report:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— **SonarCloud:** https://sonarcloud.io/project/overview?id=foyezkabir_playwright-api-automation-python" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¨ Send Slack Notification
        if: always()
        uses: slackapi/slack-github-action@70cd7be8e40a46e8169edfaa8aae9e9de75fd5d5  # v1.26.0
        with:
          status: custom
          custom_payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} API Tests - ${{ needs.test.result }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Repository:*\n${{ github.repository }}"},
                    {"type": "mrkdwn", "text": "*Branch:*\n${{ github.ref_name }}"},
                    {"type": "mrkdwn", "text": "*Run:*\n#${{ github.run_number }}"},
                    {"type": "mrkdwn", "text": "*Author:*\n${{ github.actor }}"}
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ“Š Reports:*\nâ€¢ <https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report|ğŸ“ˆ Allure Report>\nâ€¢ <https://sonarcloud.io/project/overview?id=foyezkabir_playwright-api-automation-python|ğŸ”¬ SonarCloud>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 9: CLEANUP
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [notify]
    if: always()
    permissions:
      actions: write
    
    steps:
      - name: ğŸ—‘ï¸ Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@830a412ced5fb40157e64e0f70fe67113ec7778e  # v2.0.6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10
        continue-on-error: true
      
      - name: ğŸ“‹ Cleanup Summary
        run: |
          echo "## ğŸ§¹ Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Old workflow runs older than 30 days deleted" >> $GITHUB_STEP_SUMMARY
          echo "- Minimum 10 recent runs retained" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PARALLEL: SECURITY SCAN
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: ğŸ”’ Security Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Run Safety check
        run: |
          pip install safety
          safety check --json || true
