name: API Test Automation with Enhanced Reporting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC for full regression
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests against'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  api-tests:
    name: Run API Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps chromium
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          ENV=${{ github.event.inputs.environment || 'dev' }}
          BASE_URL=${{ secrets.BASE_URL }}
          RETRY_COUNT=2
          PARALLEL_WORKERS=4
          REPORT_PORTAL_ENABLED=${{ secrets.RP_ENABLED || 'false' }}
          RP_ENDPOINT=${{ secrets.RP_ENDPOINT }}
          RP_PROJECT=${{ secrets.RP_PROJECT }}
          RP_UUID=${{ secrets.RP_UUID }}
          RP_LAUNCH_NAME="API Tests - GitHub Actions"
          EOF
      
      - name: Run tests with pytest
        id: pytest
        run: |
          pytest -v \
            --tb=short \
            --maxfail=5 \
            --reruns 2 \
            --reruns-delay 1 \
            -n auto \
            --alluredir=./allure-results \
            --clean-alluredir \
            --junitxml=./test-results/junit.xml
        continue-on-error: true
      
      - name: Generate Allure Report
        if: always()
        run: |
          # Install Allure CLI
          curl -o allure-2.25.0.tgz -L https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          tar -zxvf allure-2.25.0.tgz
          sudo mv allure-2.25.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          
          # Generate report
          allure generate ./allure-results -o ./allure-report --clean
      
      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.python-version }}
          path: ./allure-results
          retention-days: 30
      
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.python-version }}
          path: ./allure-report
          retention-days: 30
      
      - name: Publish Allure Report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main' && matrix.python-version == '3.12'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages
          destination_dir: allure-report
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}
          path: ./test-results
          retention-days: 30
      
      - name: Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: ./test-results/junit.xml
          check_name: Test Results (Python ${{ matrix.python-version }})
      
      - name: Comment PR with Test Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const testResults = fs.readFileSync('./test-results/junit.xml', 'utf8');
            
            // Parse results (simplified)
            const comment = `
            ## ðŸ§ª Test Results (Python ${{ matrix.python-version }})
            
            **Status:** ${{ steps.pytest.outcome }}
            
            ðŸ“Š [View Allure Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *Automated API Test Report*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Fail job if tests failed
        if: steps.pytest.outcome == 'failure'
        run: exit 1

  # Separate job for ReportPortal integration (when enabled)
  reportportal-summary:
    name: ReportPortal Summary
    runs-on: ubuntu-latest
    needs: api-tests
    if: always() && vars.RP_ENABLED == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate ReportPortal Summary
        run: |
          echo "ðŸ“Š Test execution completed and reported to ReportPortal"
          echo "View detailed AI-powered analysis at: ${{ secrets.RP_ENDPOINT }}"
          echo "Project: ${{ secrets.RP_PROJECT }}"

  # Security scan job
  security-scan:
    name: Security Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Safety check
        run: |
          pip install safety
          safety check --json || true
