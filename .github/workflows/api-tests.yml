name: API Test Automation with Enhanced Reporting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC for full regression
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests against'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  contents: write
  checks: write
  pull-requests: write
  pages: write
  id-token: write

# Global environment variables
env:
  TIMESTAMP: ${{ github.run_id }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: CODE QUALITY (runs in parallel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  code-quality:
    name: ğŸ¨ Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: ğŸ“¦ Install Ruff
        run: pip install ruff
      
      - name: ğŸ” Run Ruff Linter
        run: |
          echo "## ğŸ¨ Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ruff check . --output-format=github || true
          ruff check . --statistics >> $GITHUB_STEP_SUMMARY 2>&1 || true
      
      - name: ğŸ¯ Run Ruff Formatter Check
        run: |
          ruff format --check . || echo "âš ï¸ Some files need formatting" >> $GITHUB_STEP_SUMMARY

  type-check:
    name: ğŸ“Š Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install mypy types-requests
          pip install -r requirements.txt
      
      - name: ğŸ” Run MyPy Type Check
        run: |
          echo "## ğŸ“Š Type Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          mypy . --ignore-missing-imports --no-error-summary 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || true
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  build:
    name: ğŸ”¨ Build & Setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps chromium
      
      - name: ğŸ’¾ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pip-playwright-${{ hashFiles('requirements.txt') }}-${{ matrix.python-version }}
          restore-keys: |
            ${{ runner.os }}-pip-playwright-
      
      - name: ğŸ“ Create .env file
        run: |
          cat > .env << EOF
          ENV=${{ github.event.inputs.environment || 'dev' }}
          BASE_URL=https://eks-dev-lb.shadhinlab.xyz
          RETRY_COUNT=2
          PARALLEL_WORKERS=4
          REPORT_PORTAL_ENABLED=false
          EOF
      
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.python-version }}
          path: |
            .env
            requirements.txt
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: SMOKE TESTS (Fast feedback)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  smoke-tests:
    name: ğŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-3.12
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps chromium
      
      - name: ğŸ’¨ Run Smoke Tests
        run: |
          echo "## ğŸ’¨ Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          pytest tests/ -v -m "smoke" --tb=short --maxfail=3 2>&1 | tail -20 >> $GITHUB_STEP_SUMMARY || true
          pytest tests/ -v -m "smoke" --tb=short --maxfail=3
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: FULL TEST SUITE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: [build, smoke-tests]
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.python-version }}
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps chromium
      
      - name: ğŸ§ª Run tests with pytest
        id: pytest
        run: |
          pytest tests/ -v \
            --tb=short \
            --maxfail=5 \
            --reruns 2 \
            --reruns-delay 1 \
            -n auto \
            --alluredir=./allure-results \
            --clean-alluredir \
            --junitxml=./test-results/junit.xml \
            --cov=. \
            --cov-report=xml:coverage.xml \
            --cov-report=html:coverage-report
        continue-on-error: true
      
      - name: ğŸ“Š Generate Allure Report
        if: always()
        run: |
          # Install Allure CLI
          curl -o allure-2.25.0.tgz -L https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          tar -zxvf allure-2.25.0.tgz
          sudo mv allure-2.25.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          
          # Generate report
          allure generate ./allure-results -o ./allure-report --clean
      
      - name: ï¿½ Generate Artifact Metadata
        if: always()
        run: |
          CREATED_AT=$(TZ='Asia/Dhaka' date '+%d/%m/%Y %H:%M:%S')
          echo "Created: $CREATED_AT" > ./allure-results/artifact-info.txt
          echo "Created: $CREATED_AT" > ./allure-report/artifact-info.txt
          echo "Created: $CREATED_AT" > ./test-results/artifact-info.txt 2>/dev/null || mkdir -p ./test-results && echo "Created: $CREATED_AT" > ./test-results/artifact-info.txt
          echo "ARTIFACT_TIMESTAMP=$CREATED_AT" >> $GITHUB_ENV
          echo "ğŸ“… Artifact Created: $CREATED_AT" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¤ Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.python-version }}-${{ github.run_number }}
          path: ./allure-results
          retention-days: 30
      
      - name: ğŸ“¤ Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.python-version }}-${{ github.run_number }}
          path: ./allure-report
          retention-days: 30
      
      - name: ğŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}-${{ github.run_number }}
          path: ./test-results
          retention-days: 30
      
      - name: ğŸ“¤ Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}-${{ github.run_number }}
          path: |
            coverage.xml
            coverage-report/
          retention-days: 30
      
      - name: ğŸ“ˆ Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: ./test-results/junit.xml
          check_name: Test Results (Python ${{ matrix.python-version }})
      
      - name: âŒ Fail job if tests failed
        if: steps.pytest.outcome == 'failure'
        run: exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: SONARCLOUD CODE ANALYSIS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  sonarcloud:
    name: ğŸ”¬ SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: ğŸ“¥ Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-3.12-${{ github.run_number }}
          path: .
        continue-on-error: true
      
      - name: ğŸ”¬ SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.python.coverage.reportPaths=coverage.xml
      
      - name: ğŸ“‹ SonarCloud Summary
        run: |
          echo "## ğŸ”¬ SonarCloud Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **View Results:** [SonarCloud Dashboard](https://sonarcloud.io/project/overview?id=foyezkabir_playwright-api-automation-python)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Metrics Analyzed:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ› Bugs & Vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ Security Hotspots" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ’¨ Code Smells" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ˆ Duplications" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 6: COVERAGE REPORT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  coverage:
    name: ğŸ“ˆ Coverage Report
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
      - name: ğŸ“¥ Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-3.12-${{ github.run_number }}
          path: ./coverage
      
      - name: ğŸ“Š Generate Coverage Summary
        run: |
          echo "## ğŸ“ˆ Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage.xml ]; then
            echo "Coverage report generated successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 7: DEPLOY REPORTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy Reports
    runs-on: ubuntu-latest
    needs: [test, coverage, sonarcloud]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“ Create publish directory
        run: mkdir -p publish
      
      - name: ğŸ“¥ Download Allure Report (Python 3.12)
        uses: actions/download-artifact@v4
        with:
          name: allure-report-3.12-${{ github.run_number }}
          path: ./publish/allure-report
      
      - name: ğŸ  Create root redirect page
        run: |
          cat > publish/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting to Allure Report...</title>
            <meta http-equiv="refresh" content="0; url=allure-report/index.html">
            <script>
              window.location.href = "allure-report/index.html";
            </script>
          </head>
          <body>
            <p>Redirecting to <a href="allure-report/index.html">Allure Report</a>...</p>
          </body>
          </html>
          EOF
      
      - name: ğŸŒ Publish Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./publish
          publish_branch: gh-pages
      
      - name: ğŸ“‹ Report URL in Summary
        run: |
          echo "## ğŸ“Š Reports Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Report | Link |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ˆ **Allure Report** | [View Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¬ **SonarCloud** | [View Analysis](https://sonarcloud.io/project/overview?id=foyezkabir_playwright-api-automation-python) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports will be available in ~2 minutes after deployment completes." >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 7: NOTIFICATIONS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    
    steps:
      - name: ğŸ“Š Prepare Notification Summary
        id: summary
        run: |
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "status=âœ… Success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          elif [ "${{ needs.test.result }}" == "failure" ]; then
            echo "status=âŒ Failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸ ${{ needs.test.result }}" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“‹ Create GitHub Summary
        run: |
          echo "## ğŸ“¢ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¨ Code Quality | ${{ needs.code-quality.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Type Check | ${{ needs.type-check.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¨ Build | ${{ needs.build.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ’¨ Smoke Tests | ${{ needs.smoke-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ï¿½ SonarCloud | ${{ needs.sonarcloud.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ˆ Coverage | ${{ needs.coverage.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Deploy | ${{ needs.deploy.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Security | ${{ needs.security-scan.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status:** ${{ steps.summary.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Reports" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— **Allure Report:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— **SonarCloud:** https://sonarcloud.io/project/overview?id=foyezkabir_playwright-api-automation-python" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¨ Send Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} API Tests - ${{ needs.test.result }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Repository:*\n${{ github.repository }}"},
                    {"type": "mrkdwn", "text": "*Branch:*\n${{ github.ref_name }}"},
                    {"type": "mrkdwn", "text": "*Commit:*\n${{ github.event.head_commit.message }}"},
                    {"type": "mrkdwn", "text": "*Author:*\n${{ github.actor }}"}
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ“Š Reports:*\nâ€¢ <https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report|ğŸ“ˆ Allure Report>\nâ€¢ <https://sonarcloud.io/project/overview?id=foyezkabir_playwright-api-automation-python|ğŸ”¬ SonarCloud>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 9: CLEANUP
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [notify]
    if: always()
    
    steps:
      - name: ğŸ—‘ï¸ Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10
      
      - name: ğŸ“‹ Cleanup Summary
        run: |
          echo "## ğŸ§¹ Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Old workflow runs older than 30 days deleted" >> $GITHUB_STEP_SUMMARY
          echo "- Minimum 10 recent runs retained" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PARALLEL: SECURITY SCAN
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: ğŸ”’ Security Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Run Safety check
        run: |
          pip install safety
          safety check --json || true
