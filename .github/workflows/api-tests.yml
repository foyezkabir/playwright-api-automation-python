name: API Test Automation with Enhanced Reporting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC for full regression
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests against'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  contents: write
  checks: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  # Step 1: Build - Install dependencies and setup environment
  build:
    name: ðŸ”¨ Build & Setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps chromium
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pip-playwright-${{ hashFiles('requirements.txt') }}-${{ matrix.python-version }}
          restore-keys: |
            ${{ runner.os }}-pip-playwright-
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          ENV=${{ github.event.inputs.environment || 'dev' }}
          BASE_URL=${{ secrets.BASE_URL }}
          RETRY_COUNT=2
          PARALLEL_WORKERS=4
          REPORT_PORTAL_ENABLED=${{ secrets.RP_ENABLED || 'false' }}
          RP_ENDPOINT=${{ secrets.RP_ENDPOINT }}
          RP_PROJECT=${{ secrets.RP_PROJECT }}
          RP_UUID=${{ secrets.RP_UUID }}
          RP_LAUNCH_NAME="API Tests - GitHub Actions"
          EOF
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.python-version }}
          path: |
            .env
            requirements.txt
          retention-days: 1

  # Step 2: Test - Run API tests
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps chromium
      
      - name: Run tests with pytest
        id: pytest
        run: |
          pytest -v \
            --tb=short \
            --maxfail=5 \
            --reruns 2 \
            --reruns-delay 1 \
            -n auto \
            --alluredir=./allure-results \
            --clean-alluredir \
            --junitxml=./test-results/junit.xml
        continue-on-error: true
      
      - name: Generate Allure Report
        if: always()
        run: |
          # Install Allure CLI
          curl -o allure-2.25.0.tgz -L https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          tar -zxvf allure-2.25.0.tgz
          sudo mv allure-2.25.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          
          # Generate report
          allure generate ./allure-results -o ./allure-report --clean
      
      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.python-version }}
          path: ./allure-results
          retention-days: 30
      
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.python-version }}
          path: ./allure-report
          retention-days: 30
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}
          path: ./test-results
          retention-days: 30
      
      - name: Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: ./test-results/junit.xml
          check_name: Test Results (Python ${{ matrix.python-version }})
      
      - name: Fail job if tests failed
        if: steps.pytest.outcome == 'failure'
        run: exit 1

  # Step 3: Deploy - Publish Allure reports to GitHub Pages
  deploy:
    name: ðŸš€ Deploy Reports
    runs-on: ubuntu-latest
    needs: test
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Allure Report (Python 3.12)
        uses: actions/download-artifact@v4
        with:
          name: allure-report-3.12
          path: ./allure-report
      
      - name: Create root redirect page
        run: |
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting to Allure Report...</title>
            <meta http-equiv="refresh" content="0; url=allure-report/index.html">
            <script>
              window.location.href = "allure-report/index.html";
            </script>
          </head>
          <body>
            <p>Redirecting to <a href="allure-report/index.html">Allure Report</a>...</p>
          </body>
          </html>
          EOF
      
      - name: Publish Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
      
      - name: Report URL in Summary
        run: |
          echo "## ðŸ“Š Allure Report Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **View Report:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Report will be available in ~2 minutes after deployment completes." >> $GITHUB_STEP_SUMMARY

  # Security scan job
  security-scan:
    name: Security Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Safety check
        run: |
          pip install safety
          safety check --json || true
